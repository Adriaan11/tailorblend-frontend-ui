@page "/multi-agent-blend"
@using BlazorConsultant.Services
@using BlazorConsultant.Models
@using System.Text.Json
@inject IMultiAgentService MultiAgentService
@inject ISessionService SessionService

<PageTitle>Multi-Agent Formulation | TailorBlend</PageTitle>

<div class="tb-page">
    <div class="tb-page__header">
        <div style="display: flex; align-items: center; gap: var(--tb-space-16); margin-bottom: var(--tb-space-12);">
            <div class="tb-icon-container tb-icon-container--accent">
                <TbIcon Icon="sparkles" Color="accent" Size="lg" Style="font-size: 1.5rem;" />
            </div>
            <div>
                <div style="display: flex; align-items: center; gap: var(--tb-space-8); margin-bottom: var(--tb-space-4);">
                    <div class="tb-badge" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <TbIcon Icon="flask" Size="sm" />
                        Experimental
                    </div>
                </div>
                <TbText Typo="h4" Style="font-weight:700; margin: 0;">Multi-Agent Formulation</TbText>
            </div>
        </div>
        <TbText Typo="body1" Class="tb-muted">
            Powered by specialized AI agents working together to create your perfect blend.
        </TbText>
        <div style="display: flex; flex-wrap: wrap; gap: var(--tb-space-8); margin-top: var(--tb-space-12);">
            <span class="tb-chip">
                <TbIcon Icon="brain" Size="sm" />
                Intelligent Analysis
            </span>
            <span class="tb-chip">
                <TbIcon Icon="flask" Size="sm" />
                Evidence-Based
            </span>
            <span class="tb-chip">
                <TbIcon Icon="shield-check" Size="sm" />
                Safety Checked
            </span>
        </div>
    </div>

    <div class="tb-page__content">
        @if (!isGenerating && string.IsNullOrEmpty(errorMessage))
        {
            <!-- Input Form -->
            <div class="tb-card" style="margin-bottom: 2rem;">
                <div class="tb-card__header">
                    <TbText Typo="h6">Patient Profile</TbText>
                    <TbText Typo="caption" Class="tb-muted">
                        Enter health information to generate a personalized blend
                    </TbText>
                </div>

                <div class="tb-card__content">
                    <div class="tb-form-grid">
                        <!-- Basic Info -->
                        <div class="tb-form-col-6">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Patient Name</label>
                                <input type="text"
                                       class="tb-form-input"
                                       @bind="request.PatientName"
                                       placeholder="Enter patient name" />
                            </div>
                        </div>

                        <div class="tb-form-col-3">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Age</label>
                                <input type="number"
                                       class="tb-form-input"
                                       @bind="request.Age"
                                       min="1"
                                       max="120"
                                       placeholder="Age" />
                            </div>
                        </div>

                        <div class="tb-form-col-3">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Sex</label>
                                <select class="tb-form-select" @bind="request.Sex">
                                    <option value="">Select...</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                        </div>

                        <!-- Weight -->
                        <div class="tb-form-col-4">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Weight (kg)</label>
                                <input type="number"
                                       class="tb-form-input"
                                       @bind="request.Weight"
                                       min="1"
                                       max="300"
                                       step="0.1"
                                       placeholder="Weight" />
                            </div>
                        </div>

                        <!-- Dietary Preferences -->
                        <div class="tb-form-col-4">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Dietary Preferences</label>
                                <input type="text"
                                       class="tb-form-input"
                                       @bind="request.DietaryPreferences"
                                       placeholder="e.g., vegan, vegetarian, keto..." />
                            </div>
                        </div>

                        <!-- Medical Conditions -->
                        <div class="tb-form-col-4">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Medical Conditions</label>
                                <input type="text"
                                       class="tb-form-input"
                                       @bind="request.MedicalConditions"
                                       placeholder="e.g., diabetes, hypertension..." />
                            </div>
                        </div>

                        <!-- Health Goals (Required) - Full Width -->
                        <div class="tb-form-col-12">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Health Goals *</label>
                                <textarea class="tb-form-textarea"
                                          @bind="request.HealthGoals"
                                          placeholder="e.g., Better sleep, more energy, reduce stress, improve focus..."
                                          rows="3"></textarea>
                                <div class="tb-form-helper">Describe your health goals - the more detail, the better!</div>
                            </div>
                        </div>

                        <!-- Medications -->
                        <div class="tb-form-col-6">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Current Medications</label>
                                <textarea class="tb-form-textarea"
                                          @bind="request.Medications"
                                          placeholder="e.g., Metformin 500mg, Aspirin 75mg..."
                                          rows="2"></textarea>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="tb-form-col-6">
                            <div class="tb-form-group">
                                <label class="tb-form-label">Additional Information</label>
                                <textarea class="tb-form-textarea"
                                          @bind="request.AdditionalInfo"
                                          placeholder="Allergies, lifestyle, exercise habits..."
                                          rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button"
                                class="tb-button tb-button--primary"
                                @onclick="GenerateBlend"
                                disabled="@(string.IsNullOrWhiteSpace(request.HealthGoals))">
                            <TbIcon Icon="wand-magic-sparkles" Size="md" Style="margin-right: 0.5rem;" />
                            <span>Generate Multi-Agent Formulation</span>
                        </button>
                    </div>
                </div>
            </div>
        }

        @if (isGenerating)
        {
            <!-- Agent Progress Display -->
            <div class="tb-card">
                <div class="tb-card__header">
                    <TbText Typo="h6">Agent Workflow</TbText>
                    <TbText Typo="caption" Class="tb-muted">
                        Watching specialized agents work together...
                    </TbText>
                </div>

                <div class="tb-card__content">
                    @foreach (var step in agentSteps)
                    {
                        <div class="agent-step @GetStepClass(step.StepType)" style="margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                @if (step.StepType == "thinking")
                                {
                                    <div class="tb-icon-container tb-icon-container--sm tb-icon-container--info">
                                        <TbLoadingSpinner Size="sm" Variant="circular" Color="indigo" />
                                    </div>
                                }
                                else if (step.StepType == "result")
                                {
                                    <div class="tb-icon-container tb-icon-container--sm tb-icon-container--accent">
                                        <TbIcon Icon="check-circle" Color="success" Size="md" />
                                    </div>
                                }
                                else if (step.StepType == "error")
                                {
                                    <div class="tb-icon-container tb-icon-container--sm tb-icon-container--warning">
                                        <TbIcon Icon="circle-exclamation" Color="warning" Size="md" />
                                    </div>
                                }

                                <div style="flex: 1;">
                                    <TbText Typo="subtitle1" Style="font-weight:600;">@step.AgentName</TbText>
                                    <TbText Typo="body2">@step.Content</TbText>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(finalResult) && !isGenerating)
        {
            <!-- Final Results -->
            <div class="tb-card">
                <div class="tb-card__header">
                    <TbText Typo="h6">Formulation Complete!</TbText>
                    <TbText Typo="caption" Class="tb-muted">
                        Your personalized blend has been created
                    </TbText>
                </div>

                <div class="tb-card__content">
                    <div style="white-space: pre-wrap; font-family: 'Roboto Mono', monospace; font-size: 0.875rem; background: var(--bg-surface); padding: 1.5rem; border-radius: 8px;">
                        @((MarkupString)finalResult)
                    </div>

                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button"
                                class="tb-button tb-button--secondary"
                                @onclick="Reset">
                            <TbIcon Icon="rotate-right" Size="md" Style="margin-right: 0.5rem;" />
                            <span>Create Another Blend</span>
                        </button>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <!-- Error Display -->
            <div class="tb-card" style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--tb-error, #ef4444);">
                <div class="tb-card__content">
                    <TbText Typo="subtitle1" Style="font-weight:600; color: var(--tb-error, #ef4444);">Error</TbText>
                    <TbText Typo="body2" Style="margin-top: 0.5rem;">@errorMessage</TbText>
                    <div style="margin-top: 1rem;">
                        <button type="button"
                                class="tb-button tb-button--secondary"
                                @onclick="Reset">
                            <span>Try Again</span>
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .agent-step {
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid var(--tb-indigo, #6366f1);
    }

    .agent-step.thinking {
        background: rgba(99, 102, 241, 0.08);
    }

    .agent-step.result {
        background: rgba(34, 197, 94, 0.08);
        border-left-color: var(--tb-success, #22c55e);
    }

    .agent-step.error {
        background: rgba(239, 68, 68, 0.08);
        border-left-color: var(--tb-error, #ef4444);
    }
</style>

@code {
    private MultiAgentRequest request = new()
    {
        SessionId = Guid.NewGuid().ToString()
    };

    private List<AgentStepResponse> agentSteps = new();
    private bool isGenerating = false;
    private string finalResult = string.Empty;
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        // Set session ID from session service
        request.SessionId = SessionService.SessionId;
    }

    private async Task GenerateBlend()
    {
        if (string.IsNullOrWhiteSpace(request.HealthGoals))
        {
            errorMessage = "Health goals are required.";
            return;
        }

        isGenerating = true;
        errorMessage = string.Empty;
        finalResult = string.Empty;
        agentSteps.Clear();

        try
        {
            await foreach (var step in MultiAgentService.StreamFormulationAsync(request))
            {
                agentSteps.Add(step);
                StateHasChanged();

                // Check if this is the final result
                if (step.AgentName == "Multi-Agent System" && step.StepType == "result")
                {
                    // Format the final result for display
                    if (step.Data != null)
                    {
                        finalResult = FormatFinalResult(step.Data);
                    }
                }
                else if (step.StepType == "error")
                {
                    errorMessage = step.Content;
                    isGenerating = false;
                    StateHasChanged();
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private string FormatFinalResult(Dictionary<string, object> data)
    {
        // Pretty-print the JSON result
        var options = new JsonSerializerOptions
        {
            WriteIndented = true
        };
        return JsonSerializer.Serialize(data, options);
    }

    private string GetStepClass(string stepType)
    {
        return stepType.ToLower();
    }

    private void Reset()
    {
        request = new MultiAgentRequest
        {
            SessionId = SessionService.SessionId
        };
        agentSteps.Clear();
        finalResult = string.Empty;
        errorMessage = string.Empty;
        isGenerating = false;
    }
}
