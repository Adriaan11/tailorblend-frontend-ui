@using BlazorConsultant.Models

<div class="tb-model-settings">
    <!-- Panel Header -->
    <div class="tb-model-settings__header" @onclick="ToggleExpanded">
        <div class="tb-model-settings__title">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" />
            <span>Advanced Model Settings</span>
            @if (Settings.HasCustomSettings())
            {
                <span class="tb-badge tb-badge--warning">Custom</span>
            }
        </div>
        <MudIcon Icon="@(_isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Size="Size.Small" />
    </div>

    <!-- Panel Content -->
    @if (_isExpanded)
    {
        <div class="tb-model-settings__content">
            <!-- Core Settings Section -->
            <div class="tb-settings-section">
                <div class="tb-settings-section__header">
                    <span class="tb-settings-section__icon">üéØ</span>
                    <h4 class="tb-settings-section__title">Core Settings</h4>
                </div>

                <div class="tb-form-grid">
                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Temperature</label>
                        <input type="number" class="tb-form-input" @bind="Settings.Temperature" @bind:event="oninput" min="0" max="2" step="0.1" placeholder="Default" />
                        <p class="tb-form-helper">Controls creativity (0=deterministic, 2=very creative)</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Response Length</label>
                        <select class="tb-form-select" @bind="Settings.Verbosity" @bind:event="onchange">
                            <option value="">Default</option>
                            <option value="low">Concise</option>
                            <option value="medium">Balanced</option>
                            <option value="high">Detailed</option>
                        </select>
                        <p class="tb-form-helper">How verbose should responses be</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Max Tokens</label>
                        <input type="number" class="tb-form-input" @bind="Settings.MaxTokens" @bind:event="oninput" min="100" max="8000" step="100" placeholder="Default" />
                        <p class="tb-form-helper">Maximum response length (leave empty for no limit)</p>
                    </div>
                </div>
            </div>

            <!-- Sampling Settings Section -->
            <div class="tb-settings-section">
                <div class="tb-settings-section__header">
                    <span class="tb-settings-section__icon">üé≤</span>
                    <h4 class="tb-settings-section__title">Sampling Controls</h4>
                </div>

                <div class="tb-form-grid">
                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Top P</label>
                        <input type="number" class="tb-form-input" @bind="Settings.TopP" @bind:event="oninput" min="0" max="1" step="0.05" placeholder="Default" />
                        <p class="tb-form-helper">Nucleus sampling (alternative to temperature)</p>
                    </div>
                </div>
            </div>

            <!-- Penalty Settings Section -->
            <div class="tb-settings-section">
                <div class="tb-settings-section__header">
                    <span class="tb-settings-section__icon">‚öñÔ∏è</span>
                    <h4 class="tb-settings-section__title">Penalties</h4>
                </div>

                <div class="tb-form-grid">
                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Frequency Penalty</label>
                        <input type="number" class="tb-form-input" @bind="Settings.FrequencyPenalty" @bind:event="oninput" min="0" max="2" step="0.1" placeholder="Default" />
                        <p class="tb-form-helper">Reduce repetition (higher = less repetition)</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Presence Penalty</label>
                        <input type="number" class="tb-form-input" @bind="Settings.PresencePenalty" @bind:event="oninput" min="0" max="2" step="0.1" placeholder="Default" />
                        <p class="tb-form-helper">Encourage new topics (higher = more topic diversity)</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings Section -->
            <div class="tb-settings-section">
                <div class="tb-settings-section__header">
                    <span class="tb-settings-section__icon">üîß</span>
                    <h4 class="tb-settings-section__title">Advanced</h4>
                </div>

                <div class="tb-form-grid">
                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Tool Choice</label>
                        <select class="tb-form-select" @bind="Settings.ToolChoice" @bind:event="onchange">
                            <option value="">Default</option>
                            <option value="auto">Auto (let model decide)</option>
                            <option value="required">Required (force tool use)</option>
                            <option value="none">None (disable tools)</option>
                        </select>
                        <p class="tb-form-helper">Control function calling behavior</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Truncation</label>
                        <select class="tb-form-select" @bind="Settings.Truncation" @bind:event="onchange">
                            <option value="">Default</option>
                            <option value="auto">Auto (smart truncation)</option>
                            <option value="disabled">Disabled</option>
                        </select>
                        <p class="tb-form-helper">How to handle context overflow</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">
                            <input type="checkbox" @bind="Settings.ParallelToolCalls" @bind:event="onchange" style="margin-right: 8px;" />
                            Parallel Tool Calls
                        </label>
                        <p class="tb-form-helper">Allow multiple simultaneous tool calls</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">
                            <input type="checkbox" @bind="Settings.Store" @bind:event="onchange" style="margin-right: 8px;" />
                            Store Response
                        </label>
                        <p class="tb-form-helper">Save response for later retrieval</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">
                            <input type="checkbox" @bind="Settings.IncludeUsage" @bind:event="onchange" style="margin-right: 8px;" />
                            Include Usage Stats
                        </label>
                        <p class="tb-form-helper">Return detailed token usage information</p>
                    </div>

                    <div class="tb-form-col-6">
                        <label class="tb-form-label">Top Logprobs</label>
                        <input type="number" class="tb-form-input" @bind="Settings.TopLogprobs" @bind:event="oninput" min="0" max="20" step="1" placeholder="Default" />
                        <p class="tb-form-helper">Number of token probability scores to return</p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="tb-model-settings__actions">
                <button class="tb-btn tb-btn--secondary" @onclick="ResetToDefaults">
                    <MudIcon Icon="@Icons.Material.Filled.RestartAlt" Size="Size.Small" />
                    Reset to Defaults
                </button>
                @if (Settings.HasCustomSettings())
                {
                    <span class="tb-form-helper" style="color: var(--tb-warning); margin-left: 12px;">
                        ‚ö†Ô∏è Using custom settings
                    </span>
                }
            </div>
        </div>
    }
</div>

@code {
    /// <summary>
    /// The model settings object to bind to (passed from parent component).
    /// </summary>
    [Parameter]
    public ModelSettings Settings { get; set; } = new();

    /// <summary>
    /// Whether the panel is expanded by default.
    /// </summary>
    [Parameter]
    public bool InitiallyExpanded { get; set; } = false;

    private bool _isExpanded;

    protected override void OnInitialized()
    {
        _isExpanded = InitiallyExpanded;
    }

    private void ToggleExpanded()
    {
        _isExpanded = !_isExpanded;
        StateHasChanged();
    }

    private void ResetToDefaults()
    {
        Settings.ResetToDefaults();
        StateHasChanged();
    }
}
